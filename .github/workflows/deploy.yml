name: Python app check

on:
  push:
    branches: [ master ]

jobs:
  build-and-push:
    runs-on: self-hosted
    outputs:
      sha: ${{ steps.set-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v3

      - name: Set image SHA
        id: set-sha
        run: echo "::set-output name=sha::${GITHUB_SHA}"

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push test image
        run: |
          IMAGE_TEST=ghcr.io/de4ltt/python-app:test-${{ github.sha }}
          podman build --target test -t $IMAGE_TEST .
          podman push $IMAGE_TEST

      - name: Build and push runtime image
        run: |
          IMAGE_RUNTIME=ghcr.io/de4ltt/python-app:runtime-${{ github.sha }}
          podman build --target runtime -t $IMAGE_RUNTIME .
          podman push $IMAGE_RUNTIME

  test:
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Run tests via SSH
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            IMAGE_TEST=ghcr.io/de4ltt/python-app:test-${{ github.sha }}
            podman login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GHCR_TOKEN }}
            podman run --rm --name python-app-test --network host $IMAGE_TEST python -m pytest -v tests
            podman rmi $IMAGE_TEST || true
          EOF

  deploy:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Deploy runtime image via SSH
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            IMAGE_RUNTIME=ghcr.io/de4ltt/python-app:runtime-${{ github.sha }}
            podman login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GHCR_TOKEN }}
            podman stop python-app || true
            podman rm -f python-app || true
            podman run --replace -d --name python-app --network host -p 8064:8064 $IMAGE_RUNTIME
            podman images --format "{{.Repository}}:{{.Tag}}" \
              | grep 'python-app:runtime-' \
              | grep -v "${{ github.sha }}" \
              | xargs -r podman rmi -f || true
          EOF
